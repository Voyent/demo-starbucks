<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="context-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      paper-card{
        width: 100%;
        margin-bottom: 20px;
      }
      .templates{
        margin: 10px;
        box-shadow: 1px 1px 1px #EEE;
        width: 100%;
      }
      .templates, .templates div{
        box-sizing: border-box;
      }
      .templates .row{
        height: 80px;
        line-height: 80px;
      }
      .templates .row:first-child{
        height: 40px;
        line-height: 40px;
      }
      .templates .row > div {
        display: inline-block;
        width: 40%;
        vertical-align: top;
        height: 100%;
      }
      .templates .row > div:first-child{
        font-weight: bold;
        width: 19%;
      }
      .cell{
        position: relative;
      }
      paper-icon-button {
        display: block;
        text-align: center;
        color: var(--default-primary-color);
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
      }
      .temp-control{
        display: inline-block;
        width: 50%;
        float: left;
      }
      .tbl-header{
        font-weight: bold;
        padding: 5px;
        text-align: center;
      }
      .tbl-header:first-child{
        border-bottom: 1px solid #DDD;
        border-right: 1px solid #DDD;
      }
      .templates .row:first-child .tbl-header{
        border-bottom: 1px solid #DDD;
        border-right: 1px solid #DDD;
      }
    </style>
    <h2 class="page-title">Context</h2>
    <paper-card heading="Temperature">
      <div class="card-content">
        <div class="vertical center-justified layout">
          <div class="vertical-section">
            <div>
              <div class="temp-control">
                <label>Current</label>
                <div>
                  <paper-slider value="{{currentTemp}}" id="currentTempSlider"></paper-slider>
                  &nbsp;<span>{{currentTemp}}</span>&deg;
                </div>
              </div>
              <div class="temp-control">
                <label>Threshold</label>
                <div>
                  <paper-slider value="{{thresholdTemp}}" id="thresholdTempSlider"></paper-slider>
                  &nbsp;<span>{{thresholdTemp}}</span>&deg;
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </paper-card>
    
    <paper-card heading="Templates">
      <div class="card-content">
        <div class="templates">
          <div class="row">
            <div></div>
            <div class="tbl-header">Hot</div>
            <div class="tbl-header">Cold</div>
          </div>
          <div class="row">
            <div class="tbl-header">Male</div>
            <div class="cell">
              <bridgeit-document document-id="templateHotMale" attr-to-display="content" document="{{templateHotMale}}">
              </bridgeit-document>
              <paper-icon-button title="Edit" icon="create" on-click="editTemplateMaleHot"></paper-icon-button>
            </div>
            <div class="cell">
              <bridgeit-document document-id="templateColdMale" attr-to-display="content" document="{{templateColdMale}}">
              </bridgeit-document>
              <paper-icon-button title="Edit" icon="create" on-click="editTemplateMaleCold"></paper-icon-button>
            </div>
           </div>
           <div class="row">
            <div class="tbl-header">Female</div>
            <div class="cell">
              <bridgeit-document document-id="templateHotFemale" attr-to-display="content" document="{{templateHotFemale}}">
              </bridgeit-document>
              <paper-icon-button title="Edit" icon="create" on-click="editTemplateFemaleHot"></paper-icon-button>
            </div>
            <div class="cell">
              <bridgeit-document document-id="templateColdFemale" attr-to-display="content" document="{{templateColdFemale}}">
              </bridgeit-document>
              <paper-icon-button title="Edit" icon="create" on-click="editTemplateFemaleCold"></paper-icon-button>
            </div>
          </div>
        </div>
      </div>
    </paper-card>

    <paper-dialog opened="{{showEditTemplateDialog}}">
      <h2>Edit Template <span>{{currentDocument._id}}</span></h2>
      <bridgeit-document-property-text-editor document="{{currentDocument}}" document-property="content">
      </bridgeit-document-property-text-editor>
      <div class="buttons">
        <paper-button on-click="closeEditTemplateDialog">Close</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'context-view',

      ready: function(){
        var _this = this;
        bridgeit.io.documents.findDocuments({query: {type: 'temperature'}}).then(function(results){
          results.forEach(function(doc){
            if( doc._id === 'thresholdTemp'){
              _this.thresholdTemp = doc.value;
              _this.thresholdTempDoc = doc;
            }
            else if( doc._id === 'currentTemp'){
              _this.currentTemp = doc.value;
              _this.currentTempDoc = doc;
            }
          });
          _this.loaded = true;
        });
      },

      observers: ['tempChanged(currentTemp,thresholdTemp)'],

      properties: {
        loaded: {type: Boolean, notify: true},
        currentTemp: {type: Number, notify: true},
        currentTempDoc: {type: Object},
        thresholdTemp: {type: Number, notify: true},
        thresholdTempDoc: {type: Object},
        templateHotMale: {type: Object, notify: true},
        templateColdMale: {type: Object, notify: true},
        templateHotFemale: {type: Object, notify: true},
        templateColdFemale: {type: Object, notify: true},
        currentDocument: {type: Object, notify: true},
        showEditTemplateDialog: {type: Boolean, computed: '_computeShowEditTemplateDialog(currentDocument)'}
      },

      tempChanged: function(currentTemp,thresholdTemp){
        if( this.loaded){
          var _this = this;
          this.fire('temp-changed', {currentTemp: currentTemp, thresholdTemp: thresholdTemp});
          this.currentTempDoc.value = currentTemp;
          this.thresholdTempDoc.value = thresholdTemp;
          bridgeit.io.documents.updateDocument({id: this.currentTempDoc._id, document: this.currentTempDoc}).then(function(){
            return bridgeit.io.documents.updateDocument({id: this.thresholdTempDoc._id, document: this.thresholdTempDoc});
          }).catch(function(error){
            _this.fire('bridgeit-error', {error: Error('Temperature update failed: ' + this.error)});
          });
        }
      },

      editTemplateMaleHot: function(){
        console.log('editTemplateMaleHot');
        this.currentDocument = this.templateHotMale;
      },

      editTemplateMaleCold: function(){
        console.log('editTemplateMaleCold');
        this.currentDocument = this.templateColdMale;
      },

      editTemplateFemaleHot: function(){
        console.log('editTemplateFemaleHot');
        this.currentDocument = this.templateHotFemale;
      },

      editTemplateFemaleCold: function(){
        console.log('editTemplateFemaleCold');
        this.currentDocument = this.templateColdFemale;
      },

      closeEditTemplateDialog: function(){
        this.currentDocument = null;
      },

      _computeShowEditTemplateDialog: function(currentDocument){
        return !!currentDocument;
      }
    });
  })();
  </script>
</dom-module>
