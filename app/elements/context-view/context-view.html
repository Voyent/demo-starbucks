<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="context-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      paper-card{
        width: 100%;
        margin-bottom: 20px;
      }
      .templates{
        margin: 10px;
        box-shadow: 1px 1px 1px #EEE;
        width: 100%;
      }
      .templates, .templates div{
        box-sizing: border-box;
      }
      .templates .row{
        height: 80px;
      }
      .templates .row:first-child{
        height: 40px;
        line-height: 40px;
      }
      .templates .row > div {
        display: inline-block;
        width: 40%;
        vertical-align: top;
        padding: 10px;
        height: 99%;
      }
      .templates .row > div:first-child{
        font-weight: bold;
        width: 19%;
      }
      .cell{
        position: relative;
        background-color: #FFECEC;
      }
      paper-icon-button {
        display: block;
        text-align: center;
        color: var(--default-primary-color);
        position: absolute;
        top: -10px;
        right: -8px;
        width: 30px;
        height: 30px;
      }
      .temp-control{
        display: inline-block;
        width: 50%;
        float: left;
      }
      .tbl-header{
        font-weight: bold;
        padding: 5px;
        text-align: center;
      }
      .tbl-header:first-child{
        border-bottom: 1px solid #DDD;
        border-right: 1px solid #DDD;
      }
      .templates .row:first-child .tbl-header{
        border-bottom: 1px solid #DDD;
        border-right: 1px solid #DDD;
      }
      bridgeit-document-property-text-editor{
        min-height: 243px;
        min-width: 546px;
      }
    </style>

    <template is="dom-if" if="{{visible}}">
      <h2 class="page-title">Context</h2>
      <paper-card heading="Temperature">
        <div class="card-content">
          <div class="vertical center-justified layout">
            <div class="vertical-section">
              <div>
                <div class="temp-control">
                  <label>Current</label>
                  <div>
                    <paper-slider value="{{currentTemp}}" id="currentTempSlider"></paper-slider>
                    &nbsp;<span>{{currentTemp}}</span>&deg;
                  </div>
                </div>
                <div class="temp-control">
                  <label>Threshold</label>
                  <div>
                    <paper-slider value="{{thresholdTemp}}" id="thresholdTempSlider"></paper-slider>
                    &nbsp;<span>{{thresholdTemp}}</span>&deg;
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </paper-card>
      
      <paper-card heading="Templates">
        <div class="card-content">
          <div class="templates">
            <div class="row">
              <div></div>
              <div class="tbl-header">Hot</div>
              <div class="tbl-header">Cold</div>
            </div>
            <div class="row">
              <div class="tbl-header">Male</div>
              <div class="cell">
                <bridgeit-document document-id="templateMessages" attr-to-display="hotMale" document="{{templateMessagesDoc}}">
                </bridgeit-document>
                <paper-icon-button title="Edit" icon="create" on-click="editTemplateMaleHot"></paper-icon-button>
              </div>
              <div class="cell">
                <bridgeit-document document-id="templateMessages" attr-to-display="coldMale" document="{{templateMessagesDoc}}">
                </bridgeit-document>
                <paper-icon-button title="Edit" icon="create" on-click="editTemplateMaleCold"></paper-icon-button>
              </div>
             </div>
             <div class="row">
              <div class="tbl-header">Female</div>
              <div class="cell">
                <bridgeit-document document-id="templateMessages" attr-to-display="hotFemale" document="{{templateMessagesDoc}}">
                </bridgeit-document>
                <paper-icon-button title="Edit" icon="create" on-click="editTemplateFemaleHot"></paper-icon-button>
              </div>
              <div class="cell">
                <bridgeit-document document-id="templateMessages" attr-to-display="coldFemale" document="{{templateMessagesDoc}}">
                </bridgeit-document>
                <paper-icon-button title="Edit" icon="create" on-click="editTemplateFemaleCold"></paper-icon-button>
              </div>
            </div>
          </div>
        </div>
      </paper-card>

      <paper-dialog opened="{{showEditTemplateDialog}}">
        <h2>Edit Template <span>{{currentDocumentProperty}}</span></h2>
        <bridgeit-document-property-text-editor document="{{templateMessagesDoc}}" document-property="{{currentDocumentProperty}}">
        </bridgeit-document-property-text-editor>
        <div class="buttons">
          <paper-button on-click="closeEditTemplateDialog">Close</paper-button>
        </div>
      </paper-dialog>

    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'context-view',

      ready: function(){
        var _this = this;
        bridgeit.io.documents.getDocument({id: 'temperatureSettings'}).then(function(doc){
          _this.temperatureSettingsDoc = doc;
          _this.currentTemp = doc.current;
          _this.thresholdTemp = doc.threshold;
          return bridgeit.io.documents.getDocument({id: 'templateMessages'}).then(function(doc){
            _this.templateMessagesDoc = doc;
          }).then(function(){
            _this.loaded = true;
          }).catch(function(error){
            _this.fire('bridgeit-error', {error: Error('Could not fetch template messages: ' + error)});
          });
        }).catch(function(error){
          _this.fire('bridgeit-error', {error: Error('Could not fetch temperature settings: ' + error)});
        });
        
      },

      observers: ['tempChanged(currentTemp,thresholdTemp)'],

      properties: {
        visible: {type: Boolean, notify: true},
        loaded: {type: Boolean, notify: true},
        temperatureSettingsDoc: {type: Object},
        currentTemp: {type: Number, notify: true},
        thresholdTemp: {type: Number, notify: true},
        templateMessagesDoc: {type: Object},
        currentDocumentProperty: {type: Object, notify: true},
        showEditTemplateDialog: {type: Boolean, computed: '_computeShowEditTemplateDialog(currentDocumentProperty)'}
      },

      tempChanged: function(currentTemp,thresholdTemp){
        if( this.loaded && this.visible ){
          var _this = this;
          this.fire('temp-changed', {currentTemp: currentTemp, thresholdTemp: thresholdTemp});
          this.temperatureSettingsDoc.current = currentTemp;
          this.temperatureSettingsDoc.threshold = thresholdTemp;
          bridgeit.io.documents.updateDocument({id: this.temperatureSettingsDoc._id, document: this.currentTempDoc}).catch(function(error){
            _this.fire('bridgeit-error', {error: Error('Temperature update failed: ' + error)});
          });
        }
      },

      editTemplateMaleHot: function(){
        console.log('editTemplateMaleHot');
        this.currentDocumentProperty = 'hotMale';
      },

      editTemplateMaleCold: function(){
        console.log('editTemplateMaleCold');
        this.currentDocumentProperty = 'coldMale';
      },

      editTemplateFemaleHot: function(){
        console.log('editTemplateFemaleHot');
        this.currentDocumentProperty = 'hotFemale';
      },

      editTemplateFemaleCold: function(){
        console.log('editTemplateFemaleCold');
        this.currentDocumentProperty = 'coldFemale';
      },

      closeEditTemplateDialog: function(){
        this.currentDocumentProperty = null;
      },

      _computeShowEditTemplateDialog: function(currentDocumentProperty){
        return !!currentDocumentProperty;
      }
    });
  })();
  </script>
</dom-module>
